package com.recalot.unittests;

import com.recalot.common.Helper;
import com.recalot.common.communication.RecommendationResult;
import com.recalot.common.interfaces.model.rec.RecommenderInformation;
import com.recalot.unittests.helper.WebRequest;
import com.recalot.unittests.helper.WebResponse;
import flexjson.JSONDeserializer;
import org.junit.Test;

import java.util.*;

import static org.junit.Assert.*;

/**
 * Created by matthaeus.schmedding on 24.04.2015.
 */
public class RecommenderTests extends TestsBase {
    private String Path = "rec/";
    private String TrainPath = "train/";



    private HashMap sendTrain(String id, Map<String, String> params) {
        WebResponse response = WebRequest.execute(WebRequest.HTTPMethod.PUT, HOST + TrainPath, params);
        assertNotNull(response);
        assertEquals(response.getContentType(), JsonMimeType);
        assertNotNull(response.getBody());
        assertEquals(response.getResponseCode(), 200);
        HashMap info = new JSONDeserializer<HashMap>().deserialize(response.getBody());

        assertNotNull(info);
        assertNotEquals(info.get("state"), RecommenderInformation.RecommenderState.AVAILABLE.toString());
        assertEquals(info.get("id"), id);


        return info;
    }

    private HashMap getRecommendations(String id, Map<String, String> params) {

        WebResponse response = WebRequest.execute(HOST + Path + id);
        assertNotNull(response);
        assertEquals(response.getContentType(), JsonMimeType);
        assertNotNull(response.getBody());
        assertEquals(response.getResponseCode(), 200);

        HashMap rec = new JSONDeserializer<HashMap>().deserialize(response.getBody());

        assertNotNull(rec);
        assertEquals(rec.get("recommender"), id);
        assertNotNull(rec.get("items"));
        assertNotEquals(((ArrayList) rec.get("items")).size(), 0);

        return rec;
    }



    @Test
    public void testMostPopularRecommender() {
        String id = UUID.randomUUID().toString();
        Map<String, String> params = new Hashtable<>();
        params.put(Helper.Keys.SourceId, SourceId);
        params.put(Helper.Keys.RecommenderBuilderId, "mp");
        params.put(Helper.Keys.ID, id);
        params.put("topN", "10");


        HashMap train = sendTrain(id, params);

        try {
            Thread.sleep(2000);
        } catch (InterruptedException e) {
            e.printStackTrace();
            fail();
        }

        HashMap rec = getRecommendations(id, params);

        HashMap del = delete(id);
    }

    private HashMap delete(String id) {
        WebResponse response = WebRequest.execute(WebRequest.HTTPMethod.DELETE, HOST + TrainPath + id);
        assertNotNull(response);
        assertEquals(response.getContentType(), JsonMimeType);
        assertNotNull(response.getBody());
        assertEquals(response.getResponseCode(), 200);

        HashMap del = new JSONDeserializer<HashMap>().deserialize(response.getBody());

        assertNotNull(del);

        WebResponse response2 = WebRequest.execute( HOST + TrainPath + id);
        assertNull(response2);

        return del;
    }


    @Test
    public void getRecommenderStatus() {
        WebResponse response = WebRequest.execute(HOST + TrainPath);
        assertNotNull(response);
        assertEquals(response.getContentType(), JsonMimeType);
        assertNotNull(response.getBody());
        assertEquals(response.getResponseCode(), 200);
        List<RecommenderInformation> recs = new JSONDeserializer<List<RecommenderInformation>>().deserialize(response.getBody());
        assertNotNull(recs);
        assertNotEquals(recs.size(), 0);
    }

    //TODO: fill with algorithms
}
