package com.recalot.views.common;

import com.recalot.common.configuration.ConfigurationService;
import org.osgi.framework.BundleContext;

import javax.servlet.http.HttpServlet;
import java.io.Closeable;
import java.util.Dictionary;

/**
 * Created by matthaeus.schmedding on 14.04.2015.
 */
public class WebService extends ConfigurationService implements Closeable {

    private final BundleContext context;
    private String lastPath;
    private HttpServiceTracker httpTracker;
    private GenericControllerHandler handler;
    private HttpServlet servlet;

    public String PATH = "path";

    public WebService(String id, BundleContext context, GenericControllerHandler handler, HttpServlet servlet, Dictionary config) {
        setConfig(config);
        setPId(id);

        this.servlet = servlet;
        this.handler = handler;
        this.context = context;
    }

    @Override
    public void close() {
        this.httpTracker.close();
    }

    @Override
    public void onUpdate() {
        if (this.lastPath == null || !this.lastPath.equals(getConfig().get(getPId() + "." + PATH))) {
            this.httpTracker.unregister(this.lastPath);
            this.lastPath = (String) getConfig().get(getPId() + "." + PATH);
            this.httpTracker.registerServlet(lastPath, servlet, null, null);
        }
    }

    public void initialize() {
        this.httpTracker = new HttpServiceTracker(context);
        this.httpTracker.open();

        this.lastPath = getConfig().get(getPId() + "." + PATH) != null ? (String) getConfig().get(getPId() + "." + PATH) : "/";
        this.httpTracker.registerServlet(this.lastPath, servlet, null, null);
    }
}
