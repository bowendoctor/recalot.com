package com.recalot.controller.data;


import com.recalot.common.exceptions.BaseException;
import com.recalot.common.interfaces.communication.*;
import com.recalot.common.interfaces.controller.RequestAction;
import com.recalot.common.interfaces.model.DataAccess;
import com.recalot.common.interfaces.model.DataInformation;
import com.recalot.common.interfaces.model.DataSource;
import com.recalot.common.interfaces.model.Experiment;
import com.recalot.common.interfaces.template.DataTemplate;
import com.recalot.common.interfaces.template.TemplateResult;
import com.recalot.common.GenericServiceListener;
import org.osgi.framework.BundleContext;

import java.io.Closeable;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Map;


/**
 * @author matthaeus.schmedding
 */
public class DataAccessController implements com.recalot.common.interfaces.controller.DataAccessController, Closeable {

    private final BundleContext context;
    private final GenericServiceListener<DataAccess> dataAccess;
    private final GenericServiceListener<DataTemplate> dataTemplates;


    public DataAccessController(BundleContext context) {
        this.context = context;
        this.dataAccess = new GenericServiceListener<>(context, DataAccess.class.getName());
        this.dataTemplates = new GenericServiceListener(context, DataTemplate.class.getName());

        this.context.addServiceListener(dataAccess);
        this.context.addServiceListener(dataTemplates);
    }

    @Override
    public TemplateResult process(RequestAction action, String templateKey, Map<String, String> param) throws BaseException {

        TemplateResult result = null;
        DataTemplate template = null;
        try {
            template = dataTemplates.getInstance(templateKey);
            DataAccess access = dataAccess.getFirstInstance();

            switch ((DataAccessRequestAction) action) {
                case GetData: {
                    result = getData(access, template, param);
                    break;
                }
                case GetUser: {
                    result = getUser(access, template, param);
                    break;
                }
                case GetUsers: {
                    result = getUsers(access, template, param);
                    break;
                }
                case UpdateUser: {
                    result = updateUser(access, template, param);
                    break;
                }
                case CreateUser: {
                    result = createUser(access, template, param);
                    break;
                }
                case GetItems: {
                    result = getItems(access, template, param);
                    break;
                }
                case GetItem: {
                    result = getItem(access, template, param);
                    break;
                }
                case UpdateItem: {
                    result = updateItem(access, template, param);
                    break;
                }
                case CreateItem: {
                    result = createItem(access, template, param);
                    break;
                }
                case GetInteractions: {
                    result = getInteractions(access, template, param);
                    break;
                }
                case GetInteraction: {
                    result = getInteraction(access, template, param);
                    break;
                }
                case AddInteraction: {
                    result = addInteraction(access, template, param);
                    break;
                }
                case GetSources: {
                    result = getSources(access, template, param);
                    break;
                }
                case CreateSource: {
                    result = createSource(access, template, param);
                    break;
                }
                case UpdateSource: {
                    result = updateSource(access, template, param);
                    break;
                }
                case GetSource: {
                    result = getSource(access, template, param);
                    break;
                }
                case DeleteSource: {
                    result = deleteSource(access, template, param);
                    break;
                }
            }
        } catch (BaseException ex) {
            if (template != null) result = template.transform(ex);
        } catch (Exception ex) {
            if (template != null) result = template.transform(new BaseException(ex.getMessage()));
        }

        return result;
    }

    private TemplateResult getData(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        DataSource dataSource = getDataSource(access, param.get(SourceIdKey));
        DataSet data = dataSource.getDataSet();
        return template.transform(data);
    }

    private TemplateResult getUser(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        DataSource dataSource = getDataSource(access, param.get(SourceIdKey));

        String userId = param.get(UserIdKey);
        User user = dataSource.getUser(userId);
        return template.transform(user);

    }

    private TemplateResult getUsers(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        DataSource dataSource = getDataSource(access, param.get(SourceIdKey));
        //TODO: add paging
        User[] users = dataSource.getUsers();
        return template.transform(users);
    }

    private TemplateResult updateUser(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        DataSource dataSource = getDataSource(access, param.get(SourceIdKey));

        String userId = param.get(UserIdKey);

        Message message = dataSource.updateUser(userId, param);
        return template.transform(message);
    }

    private TemplateResult createUser(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        DataSource dataSource = getDataSource(access, param.get(SourceIdKey));
        Message message = dataSource.createUser(param);
        return template.transform(message);

    }

    private TemplateResult getItems(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        DataSource dataSource = getDataSource(access, param.get(SourceIdKey));
        Item[] items = dataSource.getItems();
        return template.transform(items);
    }

    private TemplateResult getItem(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        DataSource dataSource = getDataSource(access, param.get(SourceIdKey));
        Item item = dataSource.getItem(param.get(ItemIdKey));
        return template.transform(item);
    }

    private TemplateResult updateItem(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        DataSource dataSource = getDataSource(access, param.get(SourceIdKey));
        Message message = dataSource.updateItem(param.get(ItemIdKey), param);
        return template.transform(message);
    }

    private TemplateResult createItem(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        DataSource dataSource = getDataSource(access, param.get(SourceIdKey));
        Message message = dataSource.createItem(param);
        return template.transform(message);
    }

    private TemplateResult addInteraction(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        DataSource dataSource = getDataSource(access, param.get(SourceIdKey));

        String itemId = param.get(ItemIdKey);
        String userId = param.get(UserIdKey);
        String type = param.get(DataAccess.TypeKey);

        Message message = dataSource.addInteraction(itemId, userId, new Date(), type, param);
        return template.transform(message);

    }

    private TemplateResult getInteractions(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        DataSource dataSource = getDataSource(access, param.get(SourceIdKey));

        //TODO: add paging or limit output somehow. return ALL interactions can be to much for the web service
        Interaction[] interaction = dataSource.getInteractions();
        return template.transform(interaction);

    }

    private TemplateResult getInteraction(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        DataSource dataSource = getDataSource(access, param.get(SourceIdKey));

        String itemId = param.get(ItemIdKey);
        String userId = param.get(UserIdKey);

        Interaction[] interaction = dataSource.getInteractions(itemId, userId);
        return template.transform(interaction);
    }

    private TemplateResult getSources(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        List<DataInformation> sources = access.getDataInformations();

        if (param.containsKey("state")) {
            DataInformation.DataState state = DataInformation.DataState.valueOf(param.get("state"));
            List<DataInformation> temp = new ArrayList<>();
            for (DataInformation info : sources) {
                if (info.getState() == state) {
                    temp.add(info);
                }
            }

            return template.transform(temp);
        }

        return template.transform(sources);
    }

    private TemplateResult createSource(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        DataSource source = access.createDataSource(param);
        return template.transform(source);
    }

    private TemplateResult updateSource(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        String id = param.get(SourceIdKey);
        Message message = access.updateDataSource(id, param);
        return template.transform(message);
    }

    private TemplateResult getSource(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        String id = param.get(SourceIdKey);
        DataSource source = access.getDataSource(id);
        return template.transform(source);
    }

    private TemplateResult deleteSource(DataAccess access, DataTemplate template, Map<String, String> param) throws BaseException {
        String id = param.get(SourceIdKey);
        Message message = access.deleteDataSource(id);
        return template.transform(message);
    }


    private DataSource getDataSource(DataAccess access, String sourceId) throws BaseException {
        return access.getDataSource(sourceId);
    }

    @Override
    public void close() throws IOException {
        if (dataAccess != null) {
            this.context.removeServiceListener(dataAccess);
        }
        if (dataTemplates != null) {
            this.context.removeServiceListener(dataTemplates);
        }
    }
}
